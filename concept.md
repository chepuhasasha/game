# Концепция игры «Voxel Cargo»

## 1. Краткий обзор
- **Жанр:** 3D-головоломка с тактильной физикой и элементами менеджмента ресурсов.
- **Платформы:** мобильные устройства (iOS, Android) с поддержкой сенсорного экрана. Возможно портирование на ПК c мышью.
- **Цель игрока:** за ограниченное количество ходов восстановить исходный куб, заполняя контейнер коробками, полученными при разбиении.
- **Сеанс игры:** 3–7 минут. Повторное прохождение за счёт случайного разбиения и модификаторов.

## 2. Игровой цикл и состояния
1. **Подготовка уровня**
   - Выбор сложности (размер куба, количество коробок, число негативных эффектов, ограничение ходов).
   - Генерация коробок на основе seed и сохранение результата.
   - Формирование стартовой очереди коробок и заполнение буфера (изначально пуст).
2. **Раунд размещения**
   - Игрок выбирает коробку из очереди или буфера, просматривает подсказки и негативные эффекты.
   - Коробка появляется над контейнером, доступны перемещения и повороты, предварительный просмотр посадки (тень, подсветка).
   - Игрок утверждает позицию кнопкой «Загрузить», коробка падает до упора.
   - После посадки проверяются условия: совпадение с целевой формой, конфликт с эффектами, заполнение слоя.
3. **Пост-обработка**
   - Начисление очков за размещение, выполнение бонусов за слой, штрафы за ошибки.
   - Проверка победы (контейнер заполнен) и поражения (кончились ходы/место/время).
4. **Метапрогресс**
   - Игрок получает опыт, валюту и открывает новые модификаторы, визуальные темы, seed для челленджей.

## 3. Управление
- **Сенсорное управление**
  - Свайпы по поверхности контейнера с зажатой коробкой: смещение по X/Z на один воксель.
  - Вращение: двухпальцевый жест, фиксируется пошагово по 90° вокруг выбранной оси.
  - Жест «тап и удержание»: перенос коробки в буфер или возврат в очередь, если условия соблюдены.
  - Кнопки: «Загрузить», «Отменить ход» (если доступен бустер), «Бустеры» (панель с быстрым доступом).
- **ПК-управление (опционально)**
  - WASD или стрелки – перемещение, QE – вращение по вертикали, ZX – по горизонтальной оси, пробел – «Загрузить», цифры – выбор бустеров.

## 4. Пользовательский интерфейс
- **Контейнер (центр)**
  - 3D-сцена со слоем сетки, отображением тени и подсветкой целевой позиции.
  - Индикаторы: текущая высота заполнения, выделение запрещённых зон.
- **Очередь (справа)**
  - Список 3–5 предстоящих коробок, каждая с миниатюрой, размерами, иконками эффектов.
  - Возможность предпросмотра следующей коробки увеличенным видом.
- **Буфер (слева)**
  - Слоты (по умолчанию 1, можно увеличить бустером). Отображается таймер хранения, если вводится ограничение по времени.
- **Панель статуса (верх)**
  - Счёт, оставшиеся ходы/время, прогресс заполнения, активные бустеры.
- **Панель бустеров (низ)**
  - Кнопки использования с индикатором количества и отката.

## 5. Прогрессия уровней
- **Размер контейнера:** Easy — 6×6×6, Medium — 8×8×8, Hard — 10×10×10.
- **Количество коробок:** рассчитывается как объём контейнера / средний объём коробки (подстраивается seed'ом, чтобы объём совпадал).
- **Негативные эффекты:** растёт от 0–1 на Easy до 3–4 на Hard. Возможны комбинации.
- **Ограничение ходов:** базовое значение = количество коробок + 5. На высоких сложностях уменьшать на 10%.
- **Цели:** заполнить контейнер без пустот; дополнительные — завершить за X ходов, без использования бустеров, без штрафов.

## 6. Система очков и рейтинг
- **Базовые очки:** `base = volume(Box) * multiplierDifficulty`.
- **Бонус за точность:** +50% если коробка заняла исходную позицию (сравнение с `position`).
- **Бонус за слой:** при полном заполнении слоя начисляется `layerBonus = size^2 * multiplierDifficulty`.
- **Штрафы:**
  - За использование бустера удаления: −10% от текущего счёта.
  - За неполное заполнение после завершения: −5% за каждый пустой воксель.
  - За нарушение эффекта «Хрупкая»: штраф + принудительное завершение раунда.
- **Рейтинг:** после уровня игрок получает звёзды (0–3) по порогам: 1 звезда — 60%, 2 — 80%, 3 — 95% от максимального возможного счёта.

## 7. Негативные эффекты для коробок
| Название | Ограничения | Визуальный стиль | Кодовое имя |
| --- | --- | --- | --- |
| **Хрупкая** | На неё нельзя ставить другие коробки. Нарушение ведёт к разбитию и штрафу. | Прозрачное стекло с трещинами, лёгкое свечение по краям. | `FRAGILE` |
| **Некантуемая** | Запрещены вращения. В интерфейсе скрыть элементы поворота, при попытке показать предупреждение. | Аквариум с водой под сеткой, динамические капли при движении. | `NON_TILTABLE` |
| **Тяжёлая** | При падении опускается медленнее, требует 2 хода (ход на подготовку + ход на загрузку). | Металлический контейнер с гидравликой. | `HEAVY` |
| **Скользкая** | После падения сдвигается на один воксель в случайном направлении, если там пусто. | Ледяная поверхность с отражением. | `SLIPPERY` |

> Эффекты комбинируются, интерфейс должен показывать стек эффектов и их описания.

## 8. Бустеры
| Название | Описание | Стоимость | Ограничения |
| --- | --- | --- | --- |
| **Удалить коробку** | Удаляет текущую активную коробку, освобождая место. | 1 заряд на уровень, можно докупить за мягкую валюту. | Не работает на последней коробке, штраф к очкам. |
| **Отсортировать очередь** | Переставляет коробки в порядок исходного расположения. | 1 заряд, откат 3 хода. | Нельзя, если активен эффект «Скользкая» на любой коробке в очереди. |
| **Показ исходной позиции** | Подсвечивает исходное место коробки и выделяет несовпадения. | Бесплатно 3 раза, далее расходует заряд. | Действует только пока коробка в воздухе. |
| **Расширить буфер** | Добавляет временный слот буфера на 5 ходов. | Активируемый бустер. | Может быть активирован только один раз за уровень. |

## 9. Технический дизайн
### 9.1 Структуры данных
```typescript
interface Point {
  x: number;
  y: number;
  z: number;
}

interface Voxel extends Point {
  id: number;
  isFilled: boolean;
}

interface Box {
  id: number;
  readonly originalPosition: Point;
  location: 'CONTAINER' | 'QUEUE' | 'BUFFER';
  width: number;
  height: number;
  depth: number;
  debuffs: BoxDebuff[];
  playerPosition?: Point;
}

type BoxDebuff =
  | 'FRAGILE'
  | 'NON_TILTABLE'
  | 'HEAVY'
  | 'SLIPPERY';

interface LevelConfig {
  size: number;
  seed: number;
  boxCount: number;
  debuffPool: BoxDebuff[];
  moveLimit: number;
  timeLimit?: number;
}
```

### 9.2 Генерация уровня
1. **Создание voxel-грида**: 3D-массив `size³`, каждый элемент — `Voxel`. Для оптимизации хранить плоским массивом длины `size³`.
2. **Разбиение на коробки**:
   - Детально настроенный алгоритм (например, поиск случайных прямоугольных областей, flood fill с ограничениями по аспекту).
   - Важно обеспечить повторяемость: все случайные выборы зависят от `seed`.
   - Гарантировать, что каждая коробка — прямоугольный параллелепипед без пустот, суммарный объём = объёму контейнера.
3. **Назначение эффектов**: псевдослучайно, на основе таблицы вероятностей, привязанных к сложности.
4. **Формирование очереди**: перемешивание коробок алгоритмом Fisher–Yates, используя тот же генератор.
5. **Сохранение состояния**: сохраняем seed, расположение коробок, список эффектов для возможности повторного прохождения.

### 9.3 Логика размещения
- **Проверка валидности**: перед «Загрузить» проверять границы, пересечения с уже установленными коробками, соблюдение дебаффов.
- **Обновление состояния**: после посадки обновлять `location`, заполнять voxels, пересчитывать score.
- **Система отмены**: хранить стек действий (копия состояния voxels + позиции) для отката бустером.

## 10. Визуальный и звуковой стиль
- **Визуал**: низкополигональные модели, мягкое освещение, материалы с лёгкой прозрачностью для читаемости.
- **Анимации**: пружинистые easing при перемещении, частички при разрушении «хрупкой» коробки.
- **Звук**: отдельные звуки для размещения, ошибок, использования бустеров; фоновая амбиентная музыка.

## 11. Монетизация
- Бесплатное приложение с внутриигровым магазином: покупка бустеров, косметических тем.
- Ежедневные задания и сезонные челленджи с уникальными seed и лидербордом.

## 12. План разработки (MVP)
1. **Неделя 1–2:** базовая генерация коробок, отрисовка контейнера, управление перемещением.
2. **Неделя 3:** реализовать очередь, буфер, базовые эффекты (`FRAGILE`, `NON_TILTABLE`).
3. **Неделя 4:** добавить систему очков, слой бонусов, UI индикаторы.
4. **Неделя 5:** интеграция бустеров, эффекты `HEAVY`, `SLIPPERY`.
5. **Неделя 6:** полировка UX, звуки, подготовка к тестированию.

## 13. Метрики успеха
- Удержание D1 > 35%, D7 > 10%.
- Средняя длительность сессии > 4 минут.
- 70% игроков завершают обучающий уровень.

